<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalshi Data Generator UI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .controls {
            padding: 30px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .control-group {
            display: flex;
            gap: 20px;
            align-items: end;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .input-group label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9em;
        }
        
        .input-group input, .input-group select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .generate-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            height: fit-content;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .generate-btn:disabled {
            background: #cbd5e0;
            transform: none;
            box-shadow: none;
            cursor: not-allowed;
        }
        
        .logs-container {
            padding: 30px;
            background: white;
        }
        
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .logs-header h3 {
            color: #2d3748;
            font-size: 1.3em;
        }
        
        .clear-btn {
            padding: 8px 16px;
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .clear-btn:hover {
            background: #c53030;
        }
        
        .logs {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            border: 2px solid #2d3748;
        }
        
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
            display: none;
        }
        
        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }
        
        .status.running {
            background: #bee3f8;
            color: #2c5282;
            border: 1px solid #63b3ed;
        }
        
        .command-preview {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #4a5568;
        }
        
        .command-preview strong {
            color: #2d3748;
        }
        
        .chart-container {
            padding: 30px;
            background: white;
            margin: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-header h3 {
            color: #2d3748;
            font-size: 1.3em;
        }
        
        .chart-controls select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
        }
        
        .chart {
            width: 100%;
            height: 400px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Kalshi Data Generator</h1>
            <p>Generate candlestick data for temperature markets</p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <div class="input-group">
                    <label for="outdir">Output Directory</label>
                    <input type="text" id="outdir" value="./data" placeholder="./data">
                </div>
                
                <div class="input-group">
                    <label for="targetDate">Target Date</label>
                    <input type="date" id="targetDate" value="2025-08-12">
                </div>
                
                <div class="input-group">
                    <label for="interval">Interval</label>
                    <select id="interval">
                        <option value="1m">1 minute</option>
                        <option value="5m" selected>5 minutes</option>
                        <option value="1h">1 hour</option>
                        <option value="1d">1 day</option>
                    </select>
                </div>
                
                <button class="generate-btn" onclick="generateData()" id="generateBtn">
                    üöÄ Generate Data
                </button>
            </div>
            
            <div class="command-preview">
                <strong>Command:</strong> <span id="commandPreview">python3 BACKLOG!/kalshi_temp_backtest.py --outdir ./data --days (calculated) --interval 5m</span>
            </div>
            
            <div id="status" class="status"></div>
        </div>
        
        <div class="chart-container" id="chartContainer" style="display: none;">
            <div class="chart-header">
                <h3>üìä Generated Candlestick Data</h3>
                <div class="chart-controls">
                    <select id="marketSelect" onchange="loadMarketChart()">
                        <option value="">Select market...</option>
                    </select>
                </div>
            </div>
            <div id="candlestickChart" class="chart"></div>
        </div>
        
        <div class="logs-container">
            <div class="logs-header">
                <h3>üìù Generation Logs</h3>
                <button class="clear-btn" onclick="clearLogs()">Clear Logs</button>
            </div>
            <div id="logs" class="logs">Ready to generate data...\nClick "Generate Data" to start the process.\n</div>
        </div>
    </div>

    <script>
        let isGenerating = false;
        
        // Update command preview when inputs change
        function updateCommandPreview() {
            const outdir = document.getElementById('outdir').value;
            const targetDate = document.getElementById('targetDate').value;
            const interval = document.getElementById('interval').value;
            
            // Calculate days back (approximate)
            const today = new Date();
            const target = new Date(targetDate);
            const daysBack = Math.max(Math.ceil((today - target) / (1000 * 60 * 60 * 24)) + 7, 7);
            
            const command = `python3 BACKLOG!/kalshi_temp_backtest.py --outdir ${outdir} --days ${daysBack} --interval ${interval}`;
            document.getElementById('commandPreview').textContent = command;
        }
        
        // Add event listeners to update preview
        document.getElementById('outdir').addEventListener('input', updateCommandPreview);
        document.getElementById('targetDate').addEventListener('input', updateCommandPreview);
        document.getElementById('interval').addEventListener('change', updateCommandPreview);
        
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }
        
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
        
        function appendLog(message) {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.textContent += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logs').textContent = 'Logs cleared.\n';
        }
        
        async function generateData() {
            if (isGenerating) return;
            
            const generateBtn = document.getElementById('generateBtn');
            const outdir = document.getElementById('outdir').value;
            const targetDate = document.getElementById('targetDate').value;
            const interval = document.getElementById('interval').value;
            
            // Validate inputs
            if (!outdir || !targetDate || !interval) {
                showStatus('Please fill in all fields', 'error');
                return;
            }
            
            // Validate date
            if (!targetDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                showStatus('Please enter a valid date', 'error');
                return;
            }
            
            isGenerating = true;
            generateBtn.disabled = true;
            generateBtn.textContent = '‚è≥ Generating...';
            
            showStatus('Starting data generation...', 'running');
            appendLog('üöÄ Starting Kalshi data generation');
            appendLog(`Parameters: outdir=${outdir}, targetDate=${targetDate}, interval=${interval}`);
            
            try {
                // Make API call to start generation
                const response = await fetch('/generate-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        outdir: outdir,
                        targetDate: targetDate,
                        interval: interval
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(`‚úÖ Data generation completed successfully!`, 'success');
                    appendLog('‚úÖ Data generation completed successfully!');
                    appendLog(`üìÅ Output directory: ${result.outdir}`);
                    appendLog(`üìä Generated ${result.files_created || 'multiple'} candlestick files`);
                    appendLog(`‚è±Ô∏è Total time: ${result.duration || 'unknown'}`);
                    
                    // Load available markets for visualization
                    loadAvailableMarkets(result.outdir);
                } else {
                    throw new Error(result.error || 'Unknown error occurred');
                }
                
            } catch (error) {
                console.error('Generation error:', error);
                showStatus(`‚ùå Error: ${error.message}`, 'error');
                appendLog(`‚ùå Error: ${error.message}`);
                
                // If server call fails, show alternative instructions
                appendLog('üí° Alternative: Run this command manually:');
                const today = new Date();
                const target = new Date(targetDate);
                const daysBack = Math.max(Math.ceil((today - target) / (1000 * 60 * 60 * 24)) + 7, 7);
                appendLog(`   python3 BACKLOG!/kalshi_temp_backtest.py --outdir ${outdir} --days ${daysBack} --interval ${interval}`);
            } finally {
                isGenerating = false;
                generateBtn.disabled = false;
                generateBtn.textContent = 'üöÄ Generate Data';
            }
        }
        
        async function loadAvailableMarkets(outdir) {
            try {
                appendLog('üìä Loading available market files...');
                
                // Get list of generated files
                const response = await fetch('/list-markets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ outdir: outdir })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const marketFiles = result.files || [];
                    
                    appendLog(`üìà Found ${marketFiles.length} market files`);
                    
                    // Populate market selector
                    const marketSelect = document.getElementById('marketSelect');
                    marketSelect.innerHTML = '<option value="">Select market...</option>';
                    
                    marketFiles.forEach(file => {
                        const option = document.createElement('option');
                        option.value = file;
                        option.textContent = file.replace('.csv', '').replace('KXHIGHNY-', '');
                        marketSelect.appendChild(option);
                    });
                    
                    // Show chart container
                    document.getElementById('chartContainer').style.display = 'block';
                    
                    if (marketFiles.length > 0) {
                        appendLog('üìä Chart section loaded - select a market to view data');
                    }
                } else {
                    appendLog('‚ö†Ô∏è Could not load market files list');
                }
            } catch (error) {
                appendLog(`‚ùå Error loading markets: ${error.message}`);
            }
        }
        
        async function loadMarketChart() {
            const marketSelect = document.getElementById('marketSelect');
            const selectedFile = marketSelect.value;
            
            if (!selectedFile) {
                return;
            }
            
            try {
                appendLog(`üìä Loading chart data for ${selectedFile}...`);
                
                // Get market data
                const response = await fetch('/get-market-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        outdir: document.getElementById('outdir').value,
                        filename: selectedFile 
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    const candleData = result.data || [];
                    
                    appendLog(`üìà Loaded ${candleData.length} candlestick data points`);
                    
                    // Create candlestick chart
                    displayCandlestickChart(candleData, selectedFile);
                } else {
                    appendLog('‚ùå Error loading market data');
                }
            } catch (error) {
                appendLog(`‚ùå Chart error: ${error.message}`);
            }
        }
        
        function displayCandlestickChart(data, filename) {
            const chartDiv = document.getElementById('candlestickChart');
            
            if (data.length === 0) {
                chartDiv.innerHTML = '<div style="padding: 50px; text-align: center; color: #666;">No data available</div>';
                return;
            }
            
            // Prepare data for Plotly candlestick chart
            const trace = {
                x: data.map(d => d.timestamp),
                open: data.map(d => d.open),
                high: data.map(d => d.high),
                low: data.map(d => d.low),
                close: data.map(d => d.close),
                type: 'candlestick',
                name: filename.replace('.csv', ''),
                increasing: { line: { color: '#22543d' } },
                decreasing: { line: { color: '#742a2a' } }
            };
            
            const layout = {
                title: {
                    text: `${filename.replace('.csv', '')} - Candlestick Data`,
                    font: { size: 16, color: '#2d3748' }
                },
                xaxis: {
                    title: 'Time',
                    type: 'date'
                },
                yaxis: {
                    title: 'Price ($)',
                    range: [0, 100]
                },
                margin: { l: 60, r: 40, t: 60, b: 60 },
                plot_bgcolor: 'rgba(248, 250, 252, 0.8)',
                paper_bgcolor: 'white',
                showlegend: false
            };
            
            Plotly.newPlot(chartDiv, [trace], layout, {
                displayModeBar: false,
                responsive: true
            });
            
            appendLog(`üìä Chart displayed for ${filename}`);
        }
        
        // Initialize
        updateCommandPreview();
        appendLog('üéØ Kalshi Data Generator ready');
        appendLog('üìã Configure parameters above and click "Generate Data"');
    </script>
</body>
</html>