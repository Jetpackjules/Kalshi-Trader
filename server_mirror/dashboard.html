<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalshi Live Trader Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        h1 {
            margin-top: 0;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            color: white;
        }

        .status-running {
            background: #28a745;
        }

        .status-paused {
            background: #ffc107;
            color: #333;
        }

        .status-stopped {
            background: #dc3545;
        }

        .status-unknown {
            background: #6c757d;
        }

        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #eee;
            border-radius: 4px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-panel {
            margin-bottom: 20px;
            padding: 20px;
            background: #e9ecef;
            border-radius: 8px;
            border-left: 5px solid #007bff;
        }

        .btn {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .btn-start {
            background: #28a745;
            color: white;
        }

        .btn-start:hover {
            background: #218838;
        }

        .btn-stop {
            background: #dc3545;
            color: white;
        }

        .btn-stop:hover {
            background: #c82333;
        }

        .btn-refresh {
            background: #007bff;
            color: white;
        }

        .btn-refresh:hover {
            background: #0056b3;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 10px;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        #chart {
            width: 100%;
            height: 800px;
            margin-top: 20px;
        }

        .timer-badge {
            background: #17a2b8;
            margin-left: 10px;
        }

        .timer-active {
            background: #28a745;
        }

        .timer-inactive {
            background: #6c757d;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>
            <span>
                Kalshi Live Trader
                <span id="trading-timer" class="status-badge timer-badge">Checking...</span>
            </span>
            <span id="mainStatusBadge" class="status-badge status-unknown">UNKNOWN</span>
        </h1>

        <!-- Control Panel -->
        <div class="control-panel">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 style="margin: 0;">Control Center</h2>
                <div>
                    <a href="/output.log" target="_blank" class="btn"
                        style="background: #17a2b8; color: white; text-decoration: none; margin-right: 10px;">View
                        output.log</a>
                    <button id="toggleBtn" class="btn" onclick="toggleTrading()">LOADING...</button>
                    <a href="/download_trades" target="_blank" class="btn"
                        style="background: #6c757d; color: white; text-decoration: none; margin-left: 10px;">Download
                        CSV</a>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Strategy</div>
                    <div class="stat-value" id="statStrategy">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Equity</div>
                    <div class="stat-value" id="statEquity">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Daily Budget</div>
                    <div class="stat-value" id="statBudget">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Spent Today</div>
                    <div class="stat-value" id="statSpent">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Target Date</div>
                    <div class="stat-value" id="statTarget">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Trades Today</div>
                    <div class="stat-value" id="statTrades">-</div>
                </div>
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #666;">
                Last Heartbeat: <span id="lastHeartbeat">-</span>
            </div>
        </div>

        <!-- Strategy Insights Panel -->
        <div class="control-panel" style="border-left: 5px solid #6610f2; background: #f3f0ff;">
            <h2 style="margin-top: 0; color: #6610f2;">Strategy Insights ðŸ§ </h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Watching Ticker</div>
                    <div class="stat-value" id="insightTicker" style="font-size: 18px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mid Price</div>
                    <div class="stat-value" id="insightMid">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Spread</div>
                    <div class="stat-value" id="insightSpread">-</div>
                </div>
                <div class="stat-card" style="grid-column: span 2;">
                    <div class="stat-label">Decision Logic</div>
                    <div class="stat-value" id="insightReason" style="font-size: 16px; color: #6610f2;">Waiting for
                        data...</div>
                </div>
            </div>
        </div>

        <!-- Chart Controls -->
        <div class="controls">
            <label for="fileSelect">Select Market Day:</label>
            <select id="fileSelect">
                <option value="">Loading markets...</option>
            </select>
            <button class="btn btn-refresh" onclick="loadData()">Refresh Graph</button>
            <span id="status" style="margin-left: auto;">Waiting...</span>
        </div>

        <div id="chart"></div>

        <!-- Recent Trades Table -->
        <div class="container" style="margin-top: 20px; padding: 0;">
            <h2 style="padding: 20px; margin: 0; border-bottom: 1px solid #eee;">Recent Trades</h2>
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f8f9fa; text-align: left;">
                            <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Time</th>
                            <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Ticker</th>
                            <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Action</th>
                            <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Price</th>
                            <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Qty</th>
                            <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Cost</th>
                        </tr>
                    </thead>
                    <tbody id="tradesBody">
                        <tr>
                            <td colspan="6" style="padding: 12px; text-align: center;">Loading trades...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const LOG_DIR = 'market_logs/';
        let currentFile = '';
        let currentStatus = 'UNKNOWN';

        // --- TRADER CONTROL & STATUS ---
        async function updateStatus() {
            try {
                const response = await fetch('/api/status?t=' + Date.now());
                const data = await response.json();

                currentStatus = data.status;

                // Update Badge
                const badge = document.getElementById('mainStatusBadge');
                badge.innerText = data.status;
                badge.className = 'status-badge status-' + data.status.toLowerCase();

                // Update Toggle Button
                const btn = document.getElementById('toggleBtn');
                if (data.status === 'RUNNING') {
                    btn.innerText = 'â¸ PAUSE TRADING';
                    btn.className = 'btn btn-stop';
                } else {
                    btn.innerText = 'â–¶ START TRADING';
                    btn.className = 'btn btn-start';
                }
                btn.onclick = () => toggleTrading();

                // Update Stats
                document.getElementById('statStrategy').innerText = "Live V3";
                document.getElementById('statEquity').innerText = data.equity ? '$' + data.equity.toFixed(2) : '-';
                document.getElementById('statTrades').innerText = data.trades_today || '0';

                // New Stats
                document.getElementById('statBudget').innerText = data.daily_budget ? '$' + data.daily_budget.toFixed(2) : '-';
                let spentText = data.spent_today ? '$' + data.spent_today.toFixed(2) : '$0.00';
                if (data.spent_pct !== undefined) {
                    spentText += ` (${data.spent_pct.toFixed(1)}%)`;
                }
                document.getElementById('statSpent').innerText = spentText;
                document.getElementById('statTarget').innerText = data.target_date || 'All';

                document.getElementById('lastHeartbeat').innerText = data.last_update || '-';

                // Update Strategy Insights
                if (data.last_decision) {
                    const d = data.last_decision;
                    document.getElementById('insightTicker').innerText = d.ticker || '-';
                    document.getElementById('insightMid').innerText = d.mid ? d.mid.toFixed(1) + 'Â¢' : '-';
                    document.getElementById('insightSpread').innerText = d.spread ? d.spread.toFixed(1) + 'Â¢' : '-';
                    document.getElementById('insightReason').innerText = d.reason || 'Waiting...';
                }

            } catch (e) {
                console.error("Status error:", e);
                const badge = document.getElementById('mainStatusBadge');
                badge.innerText = "OFFLINE";
                badge.className = 'status-badge status-unknown';

                const btn = document.getElementById('toggleBtn');
                btn.innerText = 'OFFLINE';
                btn.className = 'btn';
                btn.disabled = true;
            }
        }

        async function toggleTrading() {
            let action = (currentStatus === 'RUNNING') ? 'stop' : 'start';

            // Optimistic UI update
            const btn = document.getElementById('toggleBtn');
            btn.innerText = 'SENDING...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/control', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action })
                });
                const result = await response.json();
                // alert(result.message); // Optional: Remove alert for smoother XP

                // Wait a bit for file to write then refresh
                setTimeout(() => {
                    updateStatus();
                    btn.disabled = false;
                }, 1000);
            } catch (e) {
                alert("Error sending command: " + e);
                btn.disabled = false;
            }
        }

        async function loadTrades() {
            try {
                const response = await fetch('/api/trades?t=' + Date.now());
                const trades = await response.json();
                const tbody = document.getElementById('tradesBody');
                tbody.innerHTML = '';

                if (trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 12px; text-align: center; color: #666;">No trades yet today.</td></tr>';
                    return;
                }

                trades.forEach(t => {
                    const tr = document.createElement('tr');
                    tr.style.borderBottom = '1px solid #eee';
                    tr.innerHTML = `
                        <td style="padding: 12px;">${t.timestamp.split(' ')[1]}</td>
                        <td style="padding: 12px;">${t.ticker}</td>
                        <td style="padding: 12px;">
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; 
                                background: ${t.action.includes('BUY') ? '#e6f4ea' : '#fce8e6'}; 
                                color: ${t.action.includes('BUY') ? '#1e7e34' : '#d93025'};">
                                ${t.action}
                            </span>
                        </td>
                        <td style="padding: 12px;">${t.price}Â¢</td>
                        <td style="padding: 12px;">${t.qty}</td>
                        <td style="padding: 12px;">$${parseFloat(t.cost).toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error("Error loading trades:", e);
            }
        }

        // --- CHART LOGIC (Existing) ---
        async function fetchManifest() {
            try {
                const response = await fetch(LOG_DIR + 'manifest.json?t=' + Date.now());
                const data = await response.json();
                const select = document.getElementById('fileSelect');
                const savedSelection = select.value;

                select.innerHTML = '';
                const files = data.files.reverse();

                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file;
                    let label = file.replace('market_data_KXHIGHNY-', '').replace('.csv', '');
                    option.text = label;
                    select.appendChild(option);
                });

                if (savedSelection && data.files.includes(savedSelection)) {
                    select.value = savedSelection;
                } else if (files.length > 0) {
                    select.value = files[0];
                }

                document.getElementById('status').innerText = 'Last updated: ' + data.last_updated;

                if (!currentFile && select.value) {
                    currentFile = select.value;
                    loadData();
                }
            } catch (e) {
                console.error("Error fetching manifest:", e);
            }
        }

        async function loadData() {
            const select = document.getElementById('fileSelect');
            const filename = select.value;
            if (!filename) return;

            currentFile = filename;
            document.getElementById('status').innerText = 'Loading ' + filename + '...';

            try {
                const response = await fetch(LOG_DIR + filename + '?t=' + Date.now());
                const text = await response.text();
                processData(text, filename);
                document.getElementById('status').innerText = 'Loaded ' + filename + ' at ' + new Date().toLocaleTimeString();
            } catch (e) {
                console.error("Error loading CSV:", e);
                document.getElementById('status').innerText = 'Error loading CSV';
            }
        }

        function processData(csvText, title) {
            const lines = csvText.trim().split('\n');
            const markets = {};

            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                if (row.length < 6) continue;

                const timestamp = row[0];
                const ticker = row[1];
                const impliedNoAsk = parseFloat(row[4]);

                if (!markets[ticker]) {
                    markets[ticker] = { x: [], y: [] };
                }

                markets[ticker].x.push(timestamp);
                markets[ticker].y.push(impliedNoAsk);
            }

            const traces = [];
            const sortedTickers = Object.keys(markets).sort();

            sortedTickers.forEach(ticker => {
                const shortName = ticker.split('-').pop();
                traces.push({
                    x: markets[ticker].x,
                    y: markets[ticker].y,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: shortName,
                    marker: { size: 4 }
                });
            });

            const layout = {
                title: 'Implied "No" Price (Cost to Buy) - ' + title.replace('market_data_', '').replace('.csv', ''),
                xaxis: { title: 'Time' },
                yaxis: { title: 'Price (Cents)', range: [0, 100] },
                hovermode: 'closest',
                showlegend: true
            };

            Plotly.newPlot('chart', traces, layout);
        }

        function updateTradingTimer() {
            // Force server time (PST)
            const now = new Date(new Date().toLocaleString("en-US", { timeZone: "America/Los_Angeles" }));
            const currentHour = now.getHours();

            // Trading windows (PST): 5-9, 13-18, 21-00
            // 05:00 - 09:00
            // 13:00 - 18:00
            // 21:00 - 00:00 (midnight)

            let isActive = false;
            let targetTime = null;
            let label = "";
            let badgeClass = "";

            if (currentHour >= 5 && currentHour < 9) {
                isActive = true;
                targetTime = new Date(now);
                targetTime.setHours(9, 0, 0, 0);
                label = "Window Closes in";
                badgeClass = "timer-active";
            } else if (currentHour >= 13 && currentHour < 18) {
                isActive = true;
                targetTime = new Date(now);
                targetTime.setHours(18, 0, 0, 0);
                label = "Window Closes in";
                badgeClass = "timer-active";
            } else if (currentHour >= 21) {
                isActive = true;
                targetTime = new Date(now);
                targetTime.setDate(targetTime.getDate() + 1);
                targetTime.setHours(0, 0, 0, 0);
                label = "Window Closes in";
                badgeClass = "timer-active";
            } else {
                // Not active, find next window
                isActive = false;
                label = "Window Opens in";
                badgeClass = "timer-inactive";
                targetTime = new Date(now);
                if (currentHour < 5) {
                    targetTime.setHours(5, 0, 0, 0);
                } else if (currentHour < 13) {
                    targetTime.setHours(13, 0, 0, 0);
                } else if (currentHour < 21) {
                    targetTime.setHours(21, 0, 0, 0);
                } else {
                    // After midnight, shouldn't happen due to >= 21 check above, but for safety
                    targetTime.setDate(targetTime.getDate() + 1);
                    targetTime.setHours(5, 0, 0, 0);
                }
            }

            const diff = targetTime - now;
            if (diff < 0) {
                // Should not happen if logic is correct, but just in case
                document.getElementById('trading-timer').innerText = "Syncing...";
                return;
            }

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            const timerText = `${hours}h ${minutes}m ${seconds}s`;
            const el = document.getElementById('trading-timer');
            el.className = `badge ${badgeClass} ms-2`;
            el.innerText = `${label}: ${timerText}`;
        }

        // Init
        fetchManifest();
        updateStatus();
        loadTrades(); // Initial load
        updateTradingTimer();

        // Loops
        setInterval(fetchManifest, 10000);
        setInterval(loadData, 30000);
        setInterval(updateStatus, 2000); // Poll status every 2s
        setInterval(loadTrades, 5000); // Poll trades every 5s
        setInterval(updateTradingTimer, 1000);

        document.getElementById('fileSelect').addEventListener('change', (e) => {
            currentFile = e.target.value;
            loadData();
        });
    </script>
</body>

</html>