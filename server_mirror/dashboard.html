<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalshi Ops Console</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --bg: #f6efe6;
            --bg-strong: #efe5d7;
            --panel: #fffaf3;
            --ink: #1f1c18;
            --muted: #6f6257;
            --accent: #2a6f5f;
            --accent-strong: #1d5749;
            --accent-warm: #d46a3b;
            --accent-warm-strong: #b35128;
            --grid: #e7dccd;
            --shadow: 0 18px 40px rgba(31, 28, 24, 0.12);
            --mono: "IBM Plex Mono", ui-monospace, monospace;
            --display: "Space Grotesk", ui-sans-serif, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: var(--display);
            color: var(--ink);
            background: radial-gradient(circle at 15% 20%, #fff7ea 0%, #f6efe6 45%, #efe5d7 100%);
        }

        .page {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px 40px;
            position: relative;
        }

        .hero {
            display: flex;
            flex-wrap: wrap;
            gap: 24px;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 28px;
        }

        .hero h1 {
            font-size: clamp(28px, 4vw, 42px);
            letter-spacing: -0.02em;
            margin: 0 0 8px;
        }

        .hero p {
            margin: 0;
            color: var(--muted);
            font-size: 15px;
            max-width: 520px;
        }

        .hero-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: flex-end;
        }

        .chip {
            background: var(--panel);
            border: 1px solid var(--grid);
            padding: 8px 12px;
            border-radius: 999px;
            font-size: 12px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            display: inline-flex;
            gap: 6px;
            align-items: center;
            box-shadow: 0 6px 16px rgba(31, 28, 24, 0.08);
        }

        .chip strong {
            font-weight: 600;
        }

        .chip a {
            text-decoration: none;
            color: inherit;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9b9084;
            display: inline-block;
        }

        .status-running {
            background: var(--accent);
        }

        .status-paused {
            background: var(--accent-warm);
        }

        .status-stopped {
            background: #b24a42;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 22px;
        }

        .panel {
            background: var(--panel);
            border: 1px solid var(--grid);
            border-radius: 18px;
            padding: 20px 22px;
            box-shadow: var(--shadow);
        }

        .panel-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
        }

        .panel-header h2 {
            margin: 0;
            font-size: 18px;
            letter-spacing: 0.01em;
        }

        .panel-header small {
            color: var(--muted);
        }

        .panel-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .btn {
            border: none;
            background: var(--accent);
            color: white;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 12px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            cursor: pointer;
        }

        .btn-secondary {
            background: var(--accent-warm);
        }

        .btn-ghost {
            background: transparent;
            color: var(--ink);
            border: 1px solid var(--grid);
        }

        .timeline {
            min-height: 260px;
        }

        #timelineChart {
            width: 100%;
            height: 260px;
        }

        #chart {
            width: 100%;
            height: 640px;
        }

        .snapshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
        }

        .snapshot-card {
            border: 1px solid var(--grid);
            border-radius: 14px;
            padding: 14px;
            background: #fff;
        }

        .snapshot-card h3 {
            margin: 0 0 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted);
        }

        .snapshot-metric {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            padding: 6px 0;
            border-bottom: 1px solid #f0e6d8;
        }

        .snapshot-metric:last-child {
            border-bottom: none;
        }

        .snapshot-metric span {
            font-family: var(--mono);
        }

        .trades-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            font-family: var(--mono);
        }

        .trades-table th,
        .trades-table td {
            border-bottom: 1px solid #eee3d4;
            padding: 8px 6px;
            text-align: left;
        }

        .health-bar {
            margin-top: 28px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .health-card {
            background: var(--panel);
            border: 1px solid var(--grid);
            border-radius: 14px;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .health-card span {
            font-size: 12px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--muted);
        }

        .health-pill {
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-family: var(--mono);
            border: 1px solid transparent;
        }

        .health-ok {
            background: rgba(42, 111, 95, 0.15);
            border-color: rgba(42, 111, 95, 0.4);
            color: var(--accent-strong);
        }

        .health-warn {
            background: rgba(212, 106, 59, 0.15);
            border-color: rgba(212, 106, 59, 0.35);
            color: var(--accent-warm-strong);
        }

        .health-off {
            background: rgba(178, 74, 66, 0.15);
            border-color: rgba(178, 74, 66, 0.35);
            color: #7f352f;
        }

        .health-unknown {
            background: rgba(111, 98, 87, 0.15);
            border-color: rgba(111, 98, 87, 0.35);
            color: var(--muted);
        }

        @media (max-width: 900px) {
            #chart {
                height: 480px;
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <header class="hero">
            <div>
                <h1>Kalshi Ops Console</h1>
                <p>Rolling 24 hour tape for live and shadow parity checks.</p>
            </div>
            <div class="hero-chips">
                <div class="chip">
                    <span class="status-dot" id="liveStatusDot"></span>
                    <strong id="liveStatusText">Live: Unknown</strong>
                </div>
                <div class="chip" id="windowChip" style="min-width: 140px; justify-content: center;">Window: --</div>
                <div class="chip" id="clockChip">Time: --</div>
                <div class="chip">
                    <a href="/output.log" target="_blank">output.log</a>
                </div>
            </div>
        </header>

        <div class="grid">
            <section class="panel timeline">
                <div class="panel-header">
                    <h2>Rolling 24h Activity</h2>
                    <small id="timelineStatus">Waiting for data...</small>
                    <div class="panel-actions">
                        <button class="btn btn-ghost" onclick="updateTimeline()">Refresh</button>
                    </div>
                </div>
                <div id="timelineChart"></div>
            </section>

            <section class="panel">
                <div class="panel-header">
                    <h2>Market Tape</h2>
                    <div class="panel-actions">
                        <label for="fileSelect" style="font-size: 12px; color: var(--muted);">Market Day</label>
                        <select id="fileSelect" class="btn btn-ghost">
                            <option value="">Loading markets...</option>
                        </select>
                        <button class="btn" onclick="loadData()">Refresh Graph</button>
                    </div>
                    <small id="graphStatus">Waiting...</small>
                </div>
                <div id="chart"></div>
            </section>

            <section class="panel">
                <div class="panel-header">
                    <h2>State Snapshot</h2>
                    <small id="snapshotStatus">Updated on refresh.</small>
                </div>
                <div class="snapshot-grid">
                    <div class="snapshot-card" id="liveSnapshot">
                        <h3>Live Trader</h3>
                        <div class="snapshot-metric">
                            <div>Equity</div><span id="liveEquity">-</span>
                        </div>
                        <div class="snapshot-metric">
                            <div>Trades Today</div><span id="liveTrades">-</span>
                        </div>
                        <div class="snapshot-metric">
                            <div>Daily Budget</div><span id="liveBudget">-</span>
                        </div>
                        <div class="snapshot-metric">
                            <div>Spent Today</div><span id="liveSpent">-</span>
                        </div>
                        <div class="snapshot-metric">
                            <div>Last Update</div><span id="liveHeartbeat">-</span>
                        </div>
                    </div>
                    <div class="snapshot-card">
                        <h3>Shadow Engine</h3>
                        <div class="snapshot-metric">
                            <div>Cash</div><span id="shadowCash">$100.00</span>
                        </div>
                        <div class="snapshot-metric">
                            <div>Positions</div><span id="shadowPositions">-</span>
                        </div>
                        <div class="snapshot-metric">
                            <div>Last Trade</div><span id="shadowTrade">No trades done yet</span>
                        </div>
                        <div class="snapshot-metric">
                            <div>Feed</div><span id="shadowFeed">market_logs</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="panel">
                <div class="panel-header">
                    <h2>Recent Live Trades</h2>
                    <small id="tradesStatus">Pulling latest trades...</small>
                </div>
                <div style="overflow-x: auto;">
                    <table class="trades-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Ticker</th>
                                <th>Action</th>
                                <th>Price</th>
                                <th>Qty</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody id="tradesBody">
                            <tr>
                                <td colspan="6">Loading trades...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="health-bar">
            <div class="health-card">
                <span>Logger</span>
                <div class="health-pill health-unknown" id="healthLogger">Unknown</div>
            </div>
            <div class="health-card">
                <span>Live Trader</span>
                <div class="health-pill health-unknown" id="healthLive">Unknown</div>
            </div>
            <div class="health-card">
                <span>Shadow</span>
                <div class="health-pill health-unknown" id="healthShadow">Unknown</div>
            </div>
            <div class="health-card">
                <span>Observer</span>
                <div class="health-pill health-unknown" id="healthObserver">Unknown</div>
            </div>
            <div class="health-card">
                <span>Dashboard</span>
                <div class="health-pill health-ok" id="healthDash">Online</div>
            </div>
        </div>
    </div>

    <script>
        const LOG_DIR = 'market_logs/';
        let currentFile = '';
        let marketCache = { ticks: [], lastTick: null };

        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function updateClock() {
            const now = new Date();
            document.getElementById('clockChip').innerText = `Time: ${formatTime(now)}`;
        }

        async function updateLiveStatus() {
            try {
                const response = await fetch(`/api/status?t=${Date.now()}`);
                const data = await response.json();
                const dot = document.getElementById('liveStatusDot');
                const text = document.getElementById('liveStatusText');
                const status = (data.status || 'UNKNOWN').toUpperCase();
                text.innerText = `Live: ${status}`;
                dot.className = 'status-dot ' + (
                    status === 'RUNNING' ? 'status-running' :
                        status === 'PAUSED' ? 'status-paused' :
                            status === 'STOPPED' ? 'status-stopped' :
                                ''
                );
                document.getElementById('liveEquity').innerText = data.equity ? `$${data.equity.toFixed(2)}` : '-';
                document.getElementById('liveTrades').innerText = data.trades_today || '0';
                document.getElementById('liveBudget').innerText = data.daily_budget ? `$${data.daily_budget.toFixed(2)}` : '-';
                let spentText = data.spent_today ? `$${data.spent_today.toFixed(2)}` : '$0.00';
                if (data.spent_pct !== undefined) {
                    spentText += ` (${data.spent_pct.toFixed(1)}%)`;
                }
                document.getElementById('liveSpent').innerText = spentText;
                document.getElementById('liveHeartbeat').innerText = data.last_update || '-';

                // Update Window Chip
                if (data.window_status) {
                    const winChip = document.getElementById('windowChip');
                    winChip.innerHTML = `<strong>${data.window_status.message}</strong>`;
                    winChip.style.color = data.window_status.color;
                    winChip.style.borderColor = data.window_status.color;
                }
            } catch (e) {
                document.getElementById('liveStatusText').innerText = 'Live: Offline';
            }
        }

        async function fetchManifest() {
            try {
                const response = await fetch(`${LOG_DIR}manifest.json?t=${Date.now()}`);
                const data = await response.json();
                const select = document.getElementById('fileSelect');
                const saved = select.value;
                select.innerHTML = '';
                const files = data.files.slice().reverse();
                files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file;
                    option.text = file.replace('market_data_KXHIGHNY-', '').replace('.csv', '');
                    select.appendChild(option);
                });
                if (saved && data.files.includes(saved)) {
                    select.value = saved;
                } else if (files.length) {
                    select.value = files[0];
                }
                if (!currentFile && select.value) {
                    currentFile = select.value;
                    loadData();
                }
            } catch (e) {
                document.getElementById('graphStatus').innerText = 'Manifest unavailable';
            }
        }

        function parseMarketCsv(csvText) {
            const lines = csvText.trim().split('\n');
            const tickPoints = [];
            const markets = {};
            for (let i = 1; i < lines.length; i++) {
                const row = lines[i].split(',');
                if (row.length < 6) continue;
                const timestamp = new Date(row[0]);
                const ticker = row[1];
                const impliedNoAsk = parseFloat(row[4]);
                if (!markets[ticker]) {
                    markets[ticker] = { x: [], y: [] };
                }
                markets[ticker].x.push(row[0]);
                markets[ticker].y.push(impliedNoAsk);
                tickPoints.push({ time: timestamp, ticker });
            }
            return { markets, tickPoints };
        }

        async function loadData() {
            const select = document.getElementById('fileSelect');
            const filename = select.value;
            if (!filename) return;
            currentFile = filename;
            document.getElementById('graphStatus').innerText = `Loading ${filename}...`;
            try {
                const response = await fetch(`${LOG_DIR}${filename}?t=${Date.now()}`);
                const text = await response.text();
                const parsed = parseMarketCsv(text);
                marketCache.ticks = parsed.tickPoints;
                marketCache.lastTick = parsed.tickPoints.length
                    ? parsed.tickPoints[parsed.tickPoints.length - 1].time
                    : null;
                renderMarketChart(parsed.markets, filename);
                document.getElementById('graphStatus').innerText = `Loaded ${filename} at ${formatTime(new Date())}`;
                updateTimeline();
                updateHealth();
            } catch (e) {
                document.getElementById('graphStatus').innerText = 'Error loading CSV';
            }
        }

        function renderMarketChart(markets, title) {
            const traces = [];
            const sortedTickers = Object.keys(markets).sort();
            sortedTickers.forEach(ticker => {
                const shortName = ticker.split('-').pop();
                traces.push({
                    x: markets[ticker].x,
                    y: markets[ticker].y,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: shortName,
                    marker: { size: 4 }
                });
            });
            const layout = {
                title: `Implied "No" Price - ${title.replace('market_data_', '').replace('.csv', '')}`,
                xaxis: { title: 'Time' },
                yaxis: { title: 'Price (Cents)', range: [0, 100] },
                hovermode: 'closest',
                showlegend: true,
                plot_bgcolor: '#fffaf3',
                paper_bgcolor: '#fffaf3',
                font: { family: 'Space Grotesk, sans-serif', color: '#1f1c18' }
            };
            Plotly.newPlot('chart', traces, layout, { displayModeBar: false });
        }

        async function fetchTradesCsv() {
            try {
                const response = await fetch(`/download_trades?t=${Date.now()}`);
                if (!response.ok) return [];
                const text = await response.text();
                const lines = text.trim().split('\n');
                if (lines.length < 2) return [];
                const headers = lines[0].split(',');
                const trades = [];
                for (let i = 1; i < lines.length; i++) {
                    const parts = lines[i].split(',');
                    if (parts.length !== headers.length) continue;
                    const row = {};
                    headers.forEach((h, idx) => row[h] = parts[idx]);
                    trades.push(row);
                }
                return trades;
            } catch (e) {
                return [];
            }
        }

        async function loadTrades() {
            try {
                const response = await fetch(`/api/trades?t=${Date.now()}`);
                const trades = await response.json();
                const tbody = document.getElementById('tradesBody');
                tbody.innerHTML = '';
                if (!trades.length) {
                    tbody.innerHTML = '<tr><td colspan="6">No trades yet.</td></tr>';
                    document.getElementById('tradesStatus').innerText = 'No trades yet.';
                    return;
                }
                trades.forEach(t => {
                    const tr = document.createElement('tr');
                    const time = t.timestamp ? t.timestamp.split(' ')[1] : '-';
                    tr.innerHTML = `
                        <td>${time}</td>
                        <td>${t.ticker || '-'}</td>
                        <td>${t.action || '-'}</td>
                        <td>${t.price || '-'}</td>
                        <td>${t.qty || '-'}</td>
                        <td>${t.cost ? `$${parseFloat(t.cost).toFixed(2)}` : '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('tradesStatus').innerText = `Updated ${formatTime(new Date())}`;
            } catch (e) {
                document.getElementById('tradesStatus').innerText = 'Trades unavailable';
            }
        }

        async function updateShadowSnapshot() {
            try {
                const response = await fetch(`/unified_engine_out/unified_positions.json?t=${Date.now()}`);
                if (!response.ok) throw new Error('missing');
                const data = await response.json();
                const positions = data.positions ? Object.keys(data.positions).length : 0;
                document.getElementById('shadowCash').innerText = data.cash ? `$${data.cash.toFixed(2)}` : '-';
                document.getElementById('shadowPositions').innerText = positions.toString();
                document.getElementById('shadowTrade').innerText = 'See trades file';
            } catch (e) {
                document.getElementById('shadowCash').innerText = '$100.00 (default)';
                document.getElementById('shadowPositions').innerText = '0';
                document.getElementById('shadowTrade').innerText = 'No trades done yet';
            }
        }

        async function updateTimeline() {
            const now = new Date();
            const start = new Date(now.getTime() - 24 * 60 * 60 * 1000);

            const marketPoints = [];
            if (marketCache.ticks.length) {
                const minuteBuckets = new Set();
                marketCache.ticks.forEach(tick => {
                    if (tick.time < start || tick.time > now) return;
                    const minuteKey = tick.time.toISOString().slice(0, 16);
                    if (!minuteBuckets.has(minuteKey)) {
                        minuteBuckets.add(minuteKey);
                        marketPoints.push(new Date(minuteKey));
                    }
                });
            }

            const liveTrades = await fetchTradesCsv();
            const livePoints = liveTrades
                .map(t => new Date(t.timestamp))
                .filter(t => !isNaN(t) && t >= start && t <= now);

            let shadowPoints = [];
            try {
                const response = await fetch(`/unified_engine_out/unified_trades.csv?t=${Date.now()}`);
                if (response.ok) {
                    const text = await response.text();
                    const lines = text.trim().split('\n');
                    shadowPoints = lines.slice(1).map(row => new Date(row.split(',')[0]));
                    shadowPoints = shadowPoints.filter(t => !isNaN(t) && t >= start && t <= now);
                }
            } catch (e) {
                shadowPoints = [];
            }

            const traces = [
                {
                    x: marketPoints,
                    y: marketPoints.map(() => 'Market ticks'),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Market ticks',
                    marker: { size: 6, color: '#2a6f5f' }
                },
                {
                    x: livePoints,
                    y: livePoints.map(() => 'Live trades'),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Live trades',
                    marker: { size: 8, color: '#d46a3b' }
                },
                {
                    x: shadowPoints,
                    y: shadowPoints.map(() => 'Shadow trades'),
                    mode: 'markers',
                    type: 'scatter',
                    name: 'Shadow trades',
                    marker: { size: 8, color: '#1d5749' }
                }
            ];

            const layout = {
                xaxis: {
                    range: [start, now],
                    title: 'Time',
                    gridcolor: '#efe3d4'
                },
                yaxis: {
                    type: 'category',
                    categoryorder: 'array',
                    categoryarray: ['Market ticks', 'Live trades', 'Shadow trades']
                },
                plot_bgcolor: '#fffaf3',
                paper_bgcolor: '#fffaf3',
                margin: { l: 90, r: 20, t: 10, b: 40 },
                font: { family: 'IBM Plex Mono, monospace', color: '#1f1c18', size: 11 },
                showlegend: false
            };

            Plotly.newPlot('timelineChart', traces, layout, { displayModeBar: false });
            document.getElementById('timelineStatus').innerText = `Updated ${formatTime(new Date())}`;
        }

        function setHealth(id, status) {
            const el = document.getElementById(id);
            if (!status || !status.state) {
                el.innerText = 'Unknown';
                el.className = 'health-pill health-unknown';
                return;
            }
            const age = status.age_s !== null ? ` (${Math.round(status.age_s)}s)` : '';
            if (status.state === 'ok') {
                el.innerText = `Active${age}`;
                el.className = 'health-pill health-ok';
            } else if (status.state === 'stale') {
                el.innerText = `Stale${age}`;
                el.className = 'health-pill health-warn';
            } else if (status.state === 'missing') {
                el.innerText = 'Missing';
                el.className = 'health-pill health-off';
            } else {
                el.innerText = 'Unknown';
                el.className = 'health-pill health-unknown';
            }
        }

        function updateHealth() {
            fetch(`/api/health?t=${Date.now()}&max_age_s=30`)
                .then(r => r.ok ? r.json() : null)
                .then(data => {
                    if (!data || !data.checks) {
                        setHealth('healthLogger', null);
                        setHealth('healthLive', null);
                        setHealth('healthShadow', null);
                        setHealth('healthObserver', null);
                        return;
                    }
                    setHealth('healthLogger', data.checks.logger);
                    setHealth('healthLive', data.checks.live_trader);
                    setHealth('healthShadow', data.checks.shadow);
                    setHealth('healthObserver', data.checks.observer);
                })
                .catch(() => {
                    setHealth('healthLogger', null);
                    setHealth('healthLive', null);
                    setHealth('healthShadow', null);
                    setHealth('healthObserver', null);
                });
        }

        document.getElementById('fileSelect').addEventListener('change', (e) => {
            currentFile = e.target.value;
            loadData();
        });

        fetchManifest();
        updateClock();
        updateLiveStatus();
        loadTrades();
        updateShadowSnapshot();
        updateTimeline();

        setInterval(fetchManifest, 10000);
        setInterval(loadData, 30000);
        setInterval(updateLiveStatus, 2500);
        setInterval(loadTrades, 6000);
        setInterval(updateClock, 1000);
        setInterval(updateTimeline, 60000);
        setInterval(updateShadowSnapshot, 45000);
        setInterval(updateHealth, 15000);
    </script>
</body>

</html>